name: CI & Deploy whatsappchatbot (Azure)

on:
  push:
    branches: ["main"]
    paths:
      - "Nichols/**"
      - "infra/**"
      - ".github/workflows/**"
      - "docker-compose.yml"
      - ".env.evolution.example"
  pull_request:
    branches: ["main"]

env:
  IMAGE_NAME: whatsappchatbot-app
  IMAGE_TAG: ${{ github.sha }}
  AZURE_RESOURCE_GROUP: rg-hackathonopenai
  AZURE_LOCATION: eastus2
  AZURE_ACR_NAME: hackathonopenaiacr
  AZURE_WEBAPP_NAME: hackathonopenai-api
  AZURE_EVOLUTION_WEBAPP: hackathonopenai-evolution
  AZURE_MONGO_DB: whatsappchatbot
  AZURE_MONGO_COLLECTION: interactions
  AZURE_MONGO_CONTAINER: hackathonopenai-mongo
  AZURE_MONGO_DNS_LABEL: hackathonopenaimongo
  AZURE_MONGO_STORAGE: hackmongoazfiles
  AZURE_MONGO_SHARE: mongodata
  AZURE_MONGO_ADMIN_USER: mongoadmin

jobs:
  test-and-deploy:
    runs-on: ubuntu-latest

    defaults:
      run:
        working-directory: Nichols

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: "pip"
          cache-dependency-path: |
            Nichols/requirements.txt

      - name: Install dependencies
        run: |
          pip install --upgrade pip
          pip install -r requirements.txt

      - name: Run tests (pytest)
        run: |
          if [ -d "tests" ]; then
            pytest -q
          else
            echo "No tests/ directory, skipping tests."
          fi

      - name: Azure login
        if: github.event_name == 'push' && github.ref == 'refs/heads/main'
        uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Provision Azure infra (Bicep)
        if: github.event_name == 'push' && github.ref == 'refs/heads/main'
        run: |
          az deployment sub create \
            --name hackathonopenai-${{ github.run_number }} \
            --location ${{ env.AZURE_LOCATION }} \
            --template-file ../infra/main.bicep \
            --parameters \
              resourceGroupName=${{ env.AZURE_RESOURCE_GROUP }} \
              location=${{ env.AZURE_LOCATION }} \
              acrName=${{ env.AZURE_ACR_NAME }} \
              webAppName=${{ env.AZURE_WEBAPP_NAME }} \
              containerImageName=${{ env.IMAGE_NAME }} \
              containerImageTag=latest \
              deployEvolutionService=true \
              evolutionWebAppName=${{ env.AZURE_EVOLUTION_WEBAPP }} \
              evolutionPlanSkuName=B1 \
              mongoDbName=${{ env.AZURE_MONGO_DB }} \
              mongoCollectionName=${{ env.AZURE_MONGO_COLLECTION }} \
              mongoContainerGroupName=${{ env.AZURE_MONGO_CONTAINER }} \
              mongoDnsLabel=${{ env.AZURE_MONGO_DNS_LABEL }} \
              mongoStorageAccountName=${{ env.AZURE_MONGO_STORAGE }} \
              mongoFileShareName=${{ env.AZURE_MONGO_SHARE }} \
              mongoAdminUsername=${{ env.AZURE_MONGO_ADMIN_USER }} \
              mongoAdminPassword=${{ secrets.AZURE_MONGO_ADMIN_PASSWORD }}

      - name: Authenticate Docker with ACR
        if: github.event_name == 'push' && github.ref == 'refs/heads/main'
        run: az acr login --name ${{ env.AZURE_ACR_NAME }}

      - name: Build and push whatsappchatbot image to ACR
        if: github.event_name == 'push' && github.ref == 'refs/heads/main'
        uses: docker/build-push-action@v6
        with:
          context: .
          file: Nichols/Dockerfile
          push: true
          tags: |
            ${{ env.AZURE_ACR_NAME }}.azurecr.io/${{ env.IMAGE_NAME }}:${{ env.IMAGE_TAG }}
            ${{ env.AZURE_ACR_NAME }}.azurecr.io/${{ env.IMAGE_NAME }}:latest

      - name: Deploy to Azure Web App (container)
        if: github.event_name == 'push' && github.ref == 'refs/heads/main'
        uses: azure/webapps-deploy@v3
        with:
          app-name: ${{ env.AZURE_WEBAPP_NAME }}
          slot-name: production
          images: |
            ${{ env.AZURE_ACR_NAME }}.azurecr.io/${{ env.IMAGE_NAME }}:latest
