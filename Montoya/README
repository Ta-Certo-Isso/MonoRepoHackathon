# ğŸ“¢ Montoya: O Motor de Engajamento (AtivaÃ§Ã£o)

> **ResponsÃ¡vel:** Montoya
> **MissÃ£o:** "Quebrar a apatia". Monitorar o caos legislativo, filtrar o que importa e transformar em conteÃºdo viral para trazer o usuÃ¡rio para a plataforma.

## ğŸ¯ Objetivo do MÃ³dulo
O `montoya` nÃ£o espera o usuÃ¡rio perguntar. Ele ativamente busca informaÃ§Ãµes pÃºblicas, simplifica a linguagem (estilo "fofoca cÃ­vica") e prepara o terreno para o disparo de mensagens.

---

## ğŸ¬ Exemplo Real

VÃ­deo completo gerado automaticamente (roteiro + render em dois clipes Sora) a partir da lei municipal que prevÃª aumento do IPTU em Pindamonhangaba:

<video src="https://raw.githubusercontent.com/Ta-Certo-Isso/MonoRepoHackathon/montoya/Montoya/output/videos/sora/run%202/projeto_que_prev_aumentar_valor_do_iptu_de_pinda_d_final.mp4" controls width="480"></video>

---

## ğŸ›  Nova Estrutura (Refatorada)

O projeto foi refatorado para utilizar **FastAPI** e uma estrutura modular profissional, pronta para deploy no Render.

```
Montoya/
â”œâ”€â”€ src/
â”‚   â”œâ”€â”€ collectors/      # Coletores (Camara, Senado, ALESP, Municipal)
â”‚   â”œâ”€â”€ services/        # OrquestraÃ§Ã£o e GeraÃ§Ã£o de ConteÃºdo (TikTok + vÃ­deos Sora)
â”‚   â”œâ”€â”€ models/          # Schemas Pydantic
â”‚   â”œâ”€â”€ core/            # ConfiguraÃ§Ã£o e Logs
â”‚   â”œâ”€â”€ utils/           # UtilitÃ¡rios (Scraper Google)
â”‚   â””â”€â”€ main.py          # App FastAPI
â”œâ”€â”€ tests/               # Testes Automatizados (Pytest)
â”œâ”€â”€ requirements.txt
â””â”€â”€ Procfile             # ConfiguraÃ§Ã£o do Render
```

---

## ğŸš€ Como Usar

### InstalaÃ§Ã£o

1. Crie e ative o ambiente virtual:
   ```bash
   python -m venv venv
   .\venv\Scripts\activate
   ```

2. Instale as dependÃªncias:
   ```bash
   pip install -r requirements.txt
   ```

3. Configure as variÃ¡veis de ambiente:
   - Renomeie `.env.example` para `.env`
   - Adicione suas chaves: `GOOGLE_SEARCH_API_KEY`, `GOOGLE_SEARCH_ENGINE_ID`, `OPENAI_API_KEY`, `AZURE_OPENAI_VIDEOS_ENDPOINT`, `AZURE_OPENAI_VIDEOS_API_KEY`

### Executando a API

```bash
uvicorn src.main:app --reload
```

Acesse a documentaÃ§Ã£o interativa em: `http://localhost:8000/docs`

### CLI Profissional

Os utilitÃ¡rios que antes ficavam soltos em `run_*.py` agora estÃ£o em um CLI unificado:

```bash
# 1. Coleta e grava no SQLite
python -m src.cli collect --days-back 5 --limit 5

# 2. Regenera roteiros aprovados
python -m src.cli regenerate-scripts

# 3. Visualiza o roteiro mais recente
python -m src.cli print-script --id 42

# 4. Renderiza vÃ­deo completo (Sora) com base no script validado
python -m src.cli generate-video --level municipal

# 5. Teste rÃ¡pido de prompt direto na Sora
python -m src.cli test-sora --prompt "A video of a cat"
```

Todos os artefatos sÃ£o salvos dentro de `Montoya/output/...` (scripts em `.json`/`.db`, vÃ­deos em `videos/sora/run */`).

### Executando Testes

O projeto inclui testes automatizados reais que verificam a integraÃ§Ã£o com as APIs externas.

```bash
pytest
```

---

## ğŸ“Š Endpoints Principais

- **`POST /collect`**: Dispara a coleta de todas as fontes.
- **`POST /generate/tiktok`**: Gera um roteiro de TikTok para uma proposiÃ§Ã£o.
- **`POST /generate/video`**: Usa o Azure OpenAI (Sora) para renderizar atÃ© ~24s em dois clipes de 12s, salvando dentro de `Montoya/output/videos/`.

### Revisando roteiros antes de renderizar

- Use `POST /generate/tiktok` com a `Proposition` desejada: a resposta jÃ¡ traz o texto completo em `script`.
- Todo roteiro salvo tambÃ©m fica no SQLite (`montoya.db`, tabela `scripts`). Basta abrir com `sqlite3` ou qualquer viewer para reaprovar/editÃ¡-lo antes de chamar `/generate/video`.

### SaÃ­da de Arquivos

Os vÃ­deos gerados pelos testes ou scripts serÃ£o salvos automaticamente na pasta:
`Montoya/output/videos/`

---

## ğŸ“ Fontes de Dados

- **Federal (CÃ¢mara):** API Dados Abertos da CÃ¢mara dos Deputados
- **Federal (Senado):** Google Search (NotÃ­cias)
- **Estadual (ALESP):** Google Search (NotÃ­cias)
- **Municipal:** Google Search (NotÃ­cias do Vale do ParaÃ­ba)

