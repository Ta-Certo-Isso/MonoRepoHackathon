# ü§ñ whatsappchatbot: O Assistente Cidad√£o (Core do WhatsApp)

> **Respons√°vel:** whatsappchatbot
> **Miss√£o:** "Traduzir a democracia". Ser a interface amig√°vel, auditiva e inteligente que conecta a 'Dona Maria' √†s leis.

## üéØ Objetivo do M√≥dulo
Este √© o c√©rebro da intera√ß√£o em tempo real. O m√≥dulo `whatsappchatbot` deve receber mensagens desestruturadas (√°udio/texto), compreender a inten√ß√£o, consultar fontes oficiais (RAG) e responder de forma emp√°tica e acess√≠vel.

### üîó Conex√£o com Regras de Neg√≥cio
* **Inclus√£o Digital:** Prioridade total para √ÅUDIO (Whisper + TTS). A persona n√£o gosta de ler text√£o.
* **Combate √† Desinforma√ß√£o:** Respostas baseadas em fatos (RAG), nunca em alucina√ß√£o pura.
* **Sem Barreira:** Zero login. O ID √© o n√∫mero de telefone (`remoteJid`).

---

## üõ† Especifica√ß√£o T√©cnica

### Stack
* **Framework:** Python FastAPI (Async √© vital para n√£o travar com I/O da OpenAI).
* **STT (Speech-to-Text):** OpenAI Whisper API.
* **LLM:** GPT-4o-mini (Custo-benef√≠cio) ou GPT-4o (Precis√£o).
* **TTS (Text-to-Speech):** OpenAI TTS (`model="tts-1"`, `voice="onyx"` ou `"alloy"`).
* **Vector DB:** ChromaDB (Local/Persistente).
* **WPP Client:** Webhook recebendo payload da Evolution API ou WPPConnect.

### üåä Fluxo de Dados (Pipeline)

```mermaid
sequenceDiagram
    participant User as Dona Maria (WhatsApp)
    participant API as whatsappchatbot API (FastAPI)
    participant AI as OpenAI (Whisper/GPT/TTS)
    participant DB as ChromaDB (RAG)

    User->>API: Envia √Åudio ("√â verdade que v√£o taxar o Pix?")
    API->>AI: Envia √°udio para Whisper
    AI-->>API: Retorna texto transcrito
    
    rect rgb(240, 240, 240)
        Note right of API: Decis√£o Inteligente
        API->>API: Classifica Inten√ß√£o (D√∫vida vs. Papo)
        API->>DB: Busca semanticamente "Taxa√ß√£o Pix"
        DB-->>API: Retorna contexto (Leis/Not√≠cias Reais)
    end
    
    API->>AI: Prompt (System + Contexto + D√∫vida)
    AI-->>API: Resposta Texto ("N√£o √© verdade...")
    API->>AI: Converte Resposta para √Åudio (TTS)
    AI-->>API: Retorna Arquivo .mp3
    API->>User: Envia √Åudio Explicativo
````

### üß† Detalhes de Implementa√ß√£o

#### 1\. System Prompt (A "Alma" do Bot)

O prompt deve ser configurado para **jamais** ser elitista.

> *"Voc√™ √© um assistente c√≠vico, neutro e amigo. Voc√™ explica leis complexas como se estivesse conversando na fila da padaria. Use analogias simples. Se a lei impacta o bolso, avise primeiro. Nunca invente leis."*

#### 2\. RAG (Retrieval-Augmented Generation)

N√£o tente indexar o mundo. Para o MVP:

  * Crie uma pasta `data/` com 5 PDFs/TXTs de leis pol√™micas atuais.
  * No startup da aplica√ß√£o, o script deve ler esses arquivos e popular o ChromaDB.

#### 3\. Output

  * Sempre envie o TEXTO curto + o √ÅUDIO.
  * Sempre cite a fonte no final do texto (ex: *"Fonte: C√¢mara dos Deputados, PL 123/23"*).

-----

## ‚úÖ Definition of Done (DoD) - Dia 1

  - [x] Webhook recebe mensagem "Oi".
  - [x] Responde com texto fixo.
  - [x] Responde convertendo texto para √°udio.
-----

## Setup rapido do Bot (FastAPI + Evolution API)

### Variaveis obrigatorias

Defina as variaveis de ambiente antes de subir o servidor (local ou Render):

````
OPENAI_API_KEY=sk-...
OPENAI_TTS_MODEL=tts-1
OPENAI_TTS_VOICE=alloy
EVOLUTION_BASE_URL=http://localhost:8080
EVOLUTION_API_KEY=sua-chave-do-evolution
EVOLUTION_INSTANCE=nome-da-instancia
# Mongo gerenciado (Azure Container Instance ou docker local)
MONGO_CONNECTION_URI=mongodb://localhost:27017
MONGO_DB_NAME=whatsappchatbot
MONGO_COLLECTION_NAME=interactions
# Opcional para validar webhooks
WEBHOOK_TOKEN=segredo-webhook
````

### Como rodar local

````
cd src/app/2-ChatBot-WhatsApp
pip install -r requirements.txt
uvicorn main:app --host 0.0.0.0 --port 8000 --reload
````

### Webhook esperado

- Endpoint: POST /webhook/evolution
- Corpo: payload JSON do Evolution API (eventos MESSAGES_UPSERT) com remoteJid e texto/√°udio. O bot ignora mensagens enviadas por ele mesmo (fromMe=true).
- Resposta: envia texto + audio TTS para o mesmo numero via Evolution (/message/sendText/{instance} e /message/sendWhatsAppAudio/{instance}).
- Memoria por sessao: historico persiste em SQLite (HISTORY_DB) por numero e √© replicado no Mongo (`MONGO_*`) para o m√≥dulo de analytics consumir dashboards.
- RAG: ao iniciar, carrega .txt em DATA_DIR e monta Chroma para recuperar contexto.
- STT: se chegar URL de audio, baixa, transcreve com Whisper e responde.
- LLM: LangChain + ChatOpenAI com system prompt civico (sem nome) + contexto RAG + historico.
- Function calling: placeholder em handle_tools para plugar consultas externas.

### Healthcheck

- GET /health retorna {"status": "ok"}.

````

## Qualidade / testes

- Crie a venv: `python -m venv .venv`
- Instale deps: `.\.venv\Scripts\python -m pip install -r src/app/2-ChatBot-WhatsApp/requirements.txt -r src/app/2-ChatBot-WhatsApp/requirements-dev.txt`
- Rode format/mypy: `.\.venv\Scripts\python -m black src/app/2-ChatBot-WhatsApp` e `.\.venv\Scripts\python -m mypy src/app/2-ChatBot-WhatsApp/main.py`
- Exemplo de teste (set envs primeiro):  
  `$env:OPENAI_API_KEY='test'; $env:EVOLUTION_BASE_URL='http://localhost'; $env:EVOLUTION_API_KEY='test'; $env:EVOLUTION_INSTANCE='instance'; .\\.venv\\Scripts\\python -m pytest src/app/2-ChatBot-WhatsApp/tests`

## Deploy / IaC

- Render Blueprint: `render.yaml` (rootDir `src/app/2-ChatBot-WhatsApp`, build `pip install -r requirements.txt`, start `uvicorn main:app --host 0.0.0.0 --port $PORT`, envs listadas).
- GitHub Actions: `.github/workflows/ci-render.yml` (teste + deploy via Deploy Hook Render; configurar secret `RENDER_DEPLOY_HOOK_URL`).
- Evolution local/VPS: `docker-compose.yml` + `.env.evolution` (copiar de `.env.evolution.example`).
- Webhook do Evolution: apontar para `/webhook/evolution` do servi√ßo no Render.

### Pr√≥ximos passos p√≥s-commit

1. Ajustar `.env` (OpenAI, Evolution, DATA_DIR/HISTORY_DB, WEBHOOK_TOKEN).
2. Criar Deploy Hook no Render e setar o secret `RENDER_DEPLOY_HOOK_URL` no GitHub.
3. Subir `.txt` em `DATA_DIR` (1¬™ linha = t√≠tulo) para o RAG.
4. Subir Evolution (docker-compose) e conectar inst√¢ncia; testar com `/api/ask` e com webhook real.

